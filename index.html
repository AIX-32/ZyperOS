<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ZyperOS</title>
  <link rel="stylesheet" href="style.css">
  <link rel="icon" href="./img/favicon.ico" sizes="any">
  <link rel="icon" type="image/png" sizes="32x32" href="./img/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="./img/favicon-16x16.png">

  <meta name="description" content="ZyperOS a well made online OS.">
  <meta name="keywords" content="ZyperOS, online OS, webOS">
  <meta name="author" content="produx.">

  
<meta property="og:title" content="ZyperOS">
  <script src="https://js.puter.com/v2/"></script>
<meta property="og:description" content="ZyperOS a well made online OS.">
<meta property="og:type" content="website">
<meta property="og:url" content="https://aix-32.github.io/ZyperOS/">
<meta property="og:image" content="./img/favicon-32x32.png">
</head>
<body>
  <div id="shell">
    <div id="output"></div>
    <form id="commandForm" style="display: flex; align-items: center;">
      <span id="commandPrompt" style="margin-right: 5px;">&gt;</span>
      <input type="text" id="commandInput" autocomplete="off" autofocus placeholder="Type a command..." style="flex: 1;">
      <button id="toggleMode" type="button" style="background: #222; color: #eee; border: 1px solid #444; padding: 6px 10px; cursor: pointer; transition: background 0.3s; margin-left: 5px; font-size: 12px;">AI</button>
    </form>
  </div>

<!-- Core OS -->
<script>
  const output = document.getElementById("output");
  const form = document.getElementById("commandForm");
  const input = document.getElementById("commandInput");

  window.apps = window.apps || {};
  const openWindows = [];

  const eventBus = {
    listeners: {},
    on(event, cb) {
      this.listeners[event] = this.listeners[event] || [];
      this.listeners[event].push(cb);
    },
    emit(event, data) {
      (this.listeners[event] || []).forEach(cb => cb(data));
    }
  };

  function print(msg) {
    const line = document.createElement("div");
    line.textContent = msg;
    output.appendChild(line);
    output.scrollTop = output.scrollHeight;
  }

  const sidebar = document.createElement("div");
  sidebar.id = "sidebar";
  sidebar.style.position = "fixed";
  sidebar.style.top = "0";
  sidebar.style.left = "0";
  sidebar.style.bottom = "0";
  sidebar.style.width = "150px";
  sidebar.style.background = "#111";
  sidebar.style.borderRight = "1px solid #333";
  sidebar.style.display = "flex";
  sidebar.style.flexDirection = "column";
  sidebar.style.padding = "10px 5px";
  sidebar.style.boxSizing = "border-box";
  sidebar.style.overflowY = "auto";
  sidebar.style.zIndex = "20000";

  const title = document.createElement("div");
  title.textContent = "Executed:";
  title.style.fontSize = "18px";
  title.style.fontWeight = "bold";
  title.style.color = "#ccc";
  title.style.margin = "10px auto";
  title.style.textAlign = "center";

  const version = document.createElement("small");
  version.textContent = "0.02";
  version.style.display = "block";
  version.style.margin = "0 auto";
  version.style.textAlign = "center";
  version.style.fontSize = "12px";
  version.style.opacity = "0.5";

  sidebar.appendChild(title);
  sidebar.appendChild(version);

  document.body.appendChild(sidebar);

  let highestZ = 1000;

  function bringToFront(win) {
    highestZ++;
    win.style.zIndex = highestZ;
  }

  function createWindow(title, launchApp, options = {}) {
    const win = document.createElement("div");
    win.className = "window";
    
    // Use app-defined or default size
    const width = options.width || "800px";
    const height = options.height || "600px";
    
    win.style.left = "170px";
    win.style.top = "50px";
    win.style.width = width;
    win.style.height = height;
    win.style.position = "absolute";
    win.style.background = "#222";
    win.style.display = "flex";
    win.style.flexDirection = "column";
    win.style.border = "1px solid #444";
    win.style.boxShadow = "2px 2px 10px #000";
    win.style.zIndex = ++highestZ;

    const taskbarBtn = document.createElement("button");
    taskbarBtn.textContent = title;
    taskbarBtn.title = "Minimize/Restore";
    taskbarBtn.style.margin = "4px 0";
    taskbarBtn.style.padding = "6px 8px";
    taskbarBtn.style.background = "#1e1e1e";
    taskbarBtn.style.color = "#eee";
    taskbarBtn.style.border = "1px solid #333";
    taskbarBtn.style.cursor = "pointer";
    taskbarBtn.style.textAlign = "left";
    taskbarBtn.style.fontWeight = "bold";
    taskbarBtn.style.whiteSpace = "nowrap";
    taskbarBtn.style.overflow = "hidden";
    taskbarBtn.style.textOverflow = "ellipsis";

    sidebar.appendChild(taskbarBtn);

    let minimized = false;

    taskbarBtn.onclick = () => {
      if (minimized) {
        win.style.display = "block";
        bringToFront(win);
        minimized = false;
      } else {
        win.style.display = "none";
        minimized = true;
      }
    };

    const titlebar = document.createElement("div");
    titlebar.className = "titlebar";
    titlebar.style.background = "#333";
    titlebar.style.padding = "5px";
    titlebar.style.cursor = "move";
    titlebar.style.display = "flex";
    titlebar.style.justifyContent = "space-between";
    titlebar.style.alignItems = "center";

    const titleSpan = document.createElement("span");
    titleSpan.textContent = title;
    titleSpan.style.fontWeight = "bold";

    const closeBtn = document.createElement("button");
    closeBtn.textContent = "X";
    closeBtn.style.background = "#900";
    closeBtn.style.color = "#fff";
    closeBtn.style.border = "none";
    closeBtn.style.padding = "2px 5px";
    closeBtn.style.cursor = "pointer";
    closeBtn.onclick = () => {
      document.body.removeChild(win);
      sidebar.removeChild(taskbarBtn);
      const index = openWindows.indexOf(win);
      if (index !== -1) openWindows.splice(index, 1);
    };

    titlebar.appendChild(titleSpan);
    titlebar.appendChild(closeBtn);
    win.appendChild(titlebar);

    const content = document.createElement("div");
    content.className = "app-content";
    content.style.padding = "10px";
    content.style.color = "#ccc";
    content.style.height = "calc(100% - 30px)";
    content.style.overflow = "auto";
    win.appendChild(content);

    let offsetX = 0, offsetY = 0;
    titlebar.onmousedown = function(e) {
      bringToFront(win);
      offsetX = e.clientX - win.offsetLeft;
      offsetY = e.clientY - win.offsetTop;

      function move(e) {
        let newX = e.clientX - offsetX;
        let newY = e.clientY - offsetY;

        newX = Math.max(newX, 150);
        newY = Math.max(newY, 0);

        const maxX = window.innerWidth - win.offsetWidth;
        const maxY = window.innerHeight - win.offsetHeight;

        newX = Math.min(newX, maxX);
        newY = Math.min(newY, maxY);

        win.style.left = newX + "px";
        win.style.top = newY + "px";
      }

      document.addEventListener("mousemove", move);
      document.addEventListener("mouseup", () => {
        document.removeEventListener("mousemove", move);
      }, {once:true});
    };

    win.onclick = () => bringToFront(win);

    document.body.appendChild(win);
    openWindows.push(win);

    launchApp(content, {eventBus});

    if (options.hidden) {
      win.style.display = 'none';
    }

    return win;
  }

  function handleCommand(raw) {
  const inputParts = raw.trim().split(" ");
  const cmd = inputParts[0];
  const args = inputParts.slice(1);

  switch (cmd) {
    case "help":
      print(getHelpText());
      break;
    case "clear":
      output.innerHTML = "";
      break;
    case "apps":
      print("Available apps:\n" + Object.keys(window.apps).join("\n"));
      break;
    case "open":
      const appName = args[0];
      if (!appName) {
        print("Usage: open [appName]");
      } else if (window.apps[appName]) {
        const appFn = window.apps[appName];
        const size = appFn.windowSize || {};
        createWindow(appName, appFn, size);
      } else {
        print(`App not found: ${appName}`);
      }
      break;
    case "testbutton":
      print("Example usage: midbutton (alert('Test Button Clicked!')) Test Button");
      print("Creating a test button now...");
      handleCommand("midbutton (alert('Test Button Clicked!')) Test Button");
      break;
    case "reloadbutton":
      print("Creating a reload button...");
      handleCommand("midbutton (location.reload()) Reload Page");
      break;
    case "midbutton":
      // Parse the command: midbutton (javascript code) button title
      const rawArgs = raw.trim().substring("midbutton".length).trim();
      // Match everything inside the first parentheses and everything after
      const jsMatch = rawArgs.match(/^\((.*)\)\s*(.+)$/);
      
      if (!jsMatch || jsMatch.length < 3) {
        print("Usage: midbutton (on click js) [button title]");
        print("Example: midbutton (alert('Hello World!')) My Button");
      } else {
        const onClickJs = jsMatch[1];
        const buttonTitle = jsMatch[2];
        
        // Create the button
        const button = document.createElement("button");
        button.textContent = buttonTitle;
        button.style.position = "fixed";
        button.style.bottom = "20px";
        button.style.left = "50%";
        button.style.transform = "translateX(-50%)";
        button.style.zIndex = "10000";
        button.style.padding = "10px 20px";
        button.style.background = "#222";
        button.style.color = "#eee";
        button.style.border = "1px solid #555";
        button.style.borderRadius = "4px";
        button.style.cursor = "pointer";
        button.style.fontFamily = "'Fira Mono', 'Courier New', Courier, monospace";
        button.style.fontSize = "14px";
        button.style.boxShadow = "0 2px 5px rgba(0,0,0,0.3)";
        // Add type to prevent form submission
        button.type = "button";
        
        // Add hover effects
        button.addEventListener("mouseenter", () => {
          button.style.background = "#333";
        });
        button.addEventListener("mouseleave", () => {
          button.style.background = "#222";
        });
        
        // Add click event with the provided JavaScript
        button.onclick = () => {
          try {
            eval(onClickJs);
          } catch (err) {
            print("Error executing button script: " + err.message);
          }
        };
        
        // Add the button to the document body
        document.body.appendChild(button);
        print(`Button "${buttonTitle}" created at bottom center`);
      }
      break;
    default:
      print(`Unknown command: ${cmd}`);
      break;
    case "openall":
      Object.keys(window.apps).forEach(appName => {
        const appFn = window.apps[appName];
        const size = appFn.windowSize || {};
        createWindow(appName, appFn, size);
      });
      break;
    case "matrix":
      openOrFocusApp("matrix");
      break;
    case "ai":
      openOrFocusApp("ai");
      break;
  }
}

// Add the midbutton command to the help text
function getHelpText() {
  return `Commands: 
  help - Show this help message
  clear - Clear the terminal output
  open [app] - Open an app (e.g., open calc)
  apps - List all available apps
  openall - Open all apps
  matrix - Show the matrix effect
  ai - Open the AI app
  midbutton (on click js) [button title] - Create a button at bottom center
    Example: midbutton (alert('Hello!')) Click Me
  testbutton - Create a test button to demonstrate functionality
  reloadbutton - Create a button that reloads the page`;
}

window.apps.matrix = function() {
    // Create fullscreen overlay
    const overlay = document.createElement("canvas");
    overlay.style.position = "fixed";
    overlay.style.top = "0";
    overlay.style.left = "0";
    overlay.style.width = "100%";
    overlay.style.height = "100%";
    overlay.style.zIndex = "99999";
    overlay.style.pointerEvents = "none"; // so it doesn't block clicks
    document.body.appendChild(overlay);

    const ctx = overlay.getContext("2d");

    function resize() {
        overlay.width = window.innerWidth;
        overlay.height = window.innerHeight;
    }
    window.addEventListener("resize", resize);
    resize();

    const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789あいうえおかきくけこさしすせそ";
    const fontSize = 16;
    const columns = Math.floor(overlay.width / fontSize);
    const drops = Array(columns).fill(1);

    function draw() {
        ctx.fillStyle = "rgba(0, 0, 0, 0.05)"; // fade effect
        ctx.fillRect(0, 0, overlay.width, overlay.height);

        ctx.fillStyle = "#fff"; // white letters
        ctx.font = fontSize + "px monospace";

        for (let i = 0; i < drops.length; i++) {
            const text = letters.charAt(Math.floor(Math.random() * letters.length));
            ctx.fillText(text, i * fontSize, drops[i] * fontSize);

            if (drops[i] * fontSize > overlay.height && Math.random() > 0.975) {
                drops[i] = 0;
            }
            drops[i]++;
        }
    }

    const interval = setInterval(draw, 50);

    // Clean up function
    return {
        destroy() {
            clearInterval(interval);
            window.removeEventListener("resize", resize);
            document.body.removeChild(overlay);
        }
    };
};


  // AI Mode state
  let aiMode = false;

  // Wait for DOM to be fully loaded before accessing elements
  document.addEventListener("DOMContentLoaded", function() {
    // Toggle button functionality
    const toggleButton = document.getElementById("toggleMode");
    const commandPrompt = document.getElementById("commandPrompt");
    
    // Add hover effects
    toggleButton.addEventListener("mouseenter", () => {
      if (!aiMode) {
        toggleButton.style.background = "#333";
      }
    });
    
    toggleButton.addEventListener("mouseleave", () => {
      if (!aiMode) {
        toggleButton.style.background = "#222";
      } else {
        toggleButton.style.background = "linear-gradient(90deg, #4CAF50, #45a049)";
      }
    });
    
    toggleButton.addEventListener("click", (e) => {
      // Prevent form submission when clicking the toggle button
      e.preventDefault();
      aiMode = !aiMode;
      if (aiMode) {
        toggleButton.textContent = "AI";
        toggleButton.style.background = "linear-gradient(90deg, #4CAF50, #45a049)";
        commandPrompt.textContent = "AI:";
        input.placeholder = "Ask AI something...";
      } else {
        toggleButton.textContent = "AI";
        toggleButton.style.background = "#222";
        commandPrompt.textContent = ">";
        input.placeholder = "Type a command...";
      }
    });
  });

  form.addEventListener("submit", async e => {
    e.preventDefault();
    const cmd = input.value;
    if (aiMode) {
      print("AI: " + cmd);
      // Process with AI
      await processAICommand(cmd);
    } else {
      print("> " + cmd);
      handleCommand(cmd);
    }
    input.value = "";
  });

  // AI command processing function
  async function processAICommand(question) {
    try {
      // Show loading message
      print("AI is thinking...");
      
      // First AI: General conversation with system context
      const conversationResponse = await puter.ai.chat([
        {
          role: "system",
          content: `You are a helpful AI assistant for ZyperOS, a web-based operating system. 
          You can help users with general questions and also help them use ZyperOS commands.
          Available apps: notes, calc, chat, scripter, appbuilder, explorer, viewer, browser, theme, taskmgr, clock, uploader, music, ai
          Available commands: help, clear, open [app], apps, openall, matrix, ai, midbutton (on click js) [button title]
          When users ask to open apps or perform system actions, be helpful but also mention that you'll translate their request into a system command.
          
          The midbutton command creates a button at the bottom center of the screen.
          Syntax: midbutton (JavaScript code) button title
          Example: midbutton (alert('Hello World!')) Click Me
          This creates a button labeled "Click Me" that shows an alert when clicked.`
        },
        {
          role: "user",
          content: question
        }
      ], {
        model: "gpt-4o-mini",
      });
      
      // Display first AI's response
      print("AI Response: " + conversationResponse);
      
      // Second AI: Command interpretation
      const commandPrompt = `You are an AI that translates natural language requests into ZyperOS system commands.
      The available commands are: help, clear, open [app], apps, openall, matrix, ai, midbutton (on click js) [button title]
      The available apps are: notes, calc, chat, scripter, appbuilder, explorer, viewer, browser, theme, taskmgr, clock, uploader, music, ai
      Respond ONLY with the exact command to execute, or "none" if no command is needed. DO NOT use code blocks or any other formatting.
      Examples:
      User: "open the calculator"
      Response: "open calc"
      
      User: "show me all apps"
      Response: "apps"
      
      User: "what time is it"
      Response: "open clock"
      
      User: "create a button that shows an alert"
      Response: "midbutton (alert('Button clicked!')) Alert Button"
      
      User: "make a button at the bottom that opens the calculator"
      Response: "midbutton (handleCommand('open calc')) Open Calculator"
      
      User: "make a button where it reloads the page"
      Response: "midbutton (location.reload()) Reload Page"
      
      User: "hello there"
      Response: "none"
      
      Request: ${question}`;
      
      const commandResponse = await puter.ai.chat([
        {
          role: "system",
          content: commandPrompt
        }
      ], {
        model: "gpt-4o-mini",
      });
      
      // Check if commandResponse is a string
      let command = "none";
      if (typeof commandResponse === 'string') {
        command = commandResponse.trim();
      } else if (commandResponse && typeof commandResponse === 'object' && commandResponse.text) {
        // Handle case where response is an object with a text property
        command = commandResponse.text.trim();
      } else if (commandResponse && typeof commandResponse.toString === 'function') {
        // Handle other object types that can be converted to string
        command = commandResponse.toString().trim();
      }
      
      // Remove markdown code blocks if present
      command = command.replace(/```.*\n?/g, '').trim();
      
      if (command !== "none" && command !== "") {
        // Execute the command
        print("Executing command: " + command);
        handleCommand(command);
        print("Command executed successfully");
      }
    } catch (error) {
      print("AI Error: " + error.message);
    }
  }

  function openOrFocusApp(appName) {

  let win = openWindows.find(w => w.dataset.appName === appName);
  if (win) {
    win.style.zIndex = Math.max(...openWindows.map(w => +w.style.zIndex)) + 1;
    return win;
  }
  const appFn = window.apps[appName];
  const size = appFn.windowSize || {};
  createWindow(appName, appFn, size);
  win = openWindows[openWindows.length - 1];
  win.dataset.appName = appName;
  return win;


  
}

function tryOpenBackgroundExplorer() {
  if (typeof createWindow === "function" && window.apps && window.apps.explorer) {
    // Create the explorer window in hidden state
    window.backgroundExplorer = createWindow("Explorer", window.apps.explorer, { hidden: true });
  } else {
    setTimeout(tryOpenBackgroundExplorer, 50);
  }
}

// Call this at startup
tryOpenBackgroundExplorer();

// Function user can call to show Explorer window
function showExplorer() {
  if (window.backgroundExplorer) {
    window.backgroundExplorer.style.display = "block";
    // Bring it to front if you want
    window.backgroundExplorer.style.zIndex = Math.max(...openWindows.map(w => +w.style.zIndex)) + 1;
  } else {
    // If not ready, just open normally
    if (window.apps && window.apps.explorer) {
      createWindow("Explorer", window.apps.explorer);
    }
  }
}

// Initialize start time
if (!window.osStartTime) window.osStartTime = Date.now();


  print("Booting ZyperOS...\nBooting Explorer...\nMake sure to star me on Github!\n\nType 'help' to begin.");
</script>

  <!-- apps --> 
  <script src="apps/notes.js"></script>
  <script src="apps/calc.js"></script>
  <script src="apps/chat.js"></script>
  <script src="apps/scripter.js"></script>
  <script src="apps/appbuilder.js"></script>
  <script src="apps/explorer.js"></script>
  <script src="apps/viewer.js"></script>
  <script src="apps/browser.js"></script>
  <script src="apps/theme.js"></script>
  <script src="apps/taskmgr.js"></script>
  <script src="apps/clock.js"></script>
  <script src="apps/uploader.js"></script>
  <script src="apps/music.js"></script>
  <script src="apps/ai.js"></script>
</body>
</html>